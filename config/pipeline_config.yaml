# Pipeline Configuration
# Configuration for the Generative Agent Pipeline

# General settings
general:
  project_name: "Generative Agent Pipeline"
  version: "1.0.0"
  log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  log_file: "logs/pipeline.log"

# Database settings
database:
  path: "pipeline.db"
  backup_enabled: true
  backup_interval_hours: 24

# Git settings
git:
  base_branch: "main"
  worktrees_dir: ".worktrees"
  auto_cleanup: true
  merge_strategy: "recursive"  # recursive, ours, theirs
  conflict_resolution: "manual"  # auto, manual

# Agent settings
agents:
  # Path to agent templates in WSL
  templates_path: "~/.claude/agents"

  # Default model for agents
  default_model: "opus"

  # Agent role to template mapping
  role_mapping:
    coder: "senior-engineer"
    verifier: "code-reviewer"
    tester: "test-engineer"
    analyst: "system-architect"
    master: "system-architect"
    qa: "qa-specialist"
    security: "security-auditor"
    performance: "performance-optimizer"
    documentation: "documentation-writer"

  # Timeout settings (in seconds)
  timeouts:
    coder: 3600      # 1 hour
    verifier: 1800   # 30 minutes
    tester: 2400     # 40 minutes
    analyst: 1200    # 20 minutes

# Spec settings
specs:
  directory: "specs"
  schema_path: "config/spec_schema.json"
  validate: true  # Validate specs against schema
  format: "json"  # json, yaml

# Phase 0: Master Analyst
phase0:
  enabled: true
  template: "system-architect"
  model: "opus"

  # Master analyst configuration
  max_domains: 10  # Maximum number of domains to identify
  min_domains: 1   # Minimum number of domains required

  # Specialization templates for different domains
  domain_templates:
    authentication: "security-auditor"
    api: "api-designer"
    database: "database-specialist"
    frontend: "ui-ux-designer"
    backend: "senior-engineer"
    devops: "devops-engineer"
    testing: "test-automation"
    performance: "performance-optimizer"

# Phase 1: Specialist Analysts
phase1:
  enabled: true
  parallel_execution: true
  max_parallel_agents: 5  # Maximum number of analysts running simultaneously

  # Task ID generation
  task_id_format: "TASK-{counter:03d}"
  task_id_start: 101  # Starting counter value

# Phase 2: Dispatcher
phase2:
  enabled: true
  watch_interval: 5  # Seconds between checks for new specs
  max_tasks: 50  # Maximum number of tasks to dispatch

  # Dependency resolution
  check_dependencies: true
  max_dependency_depth: 3

# Phase 3: Coder Agents
phase3:
  enabled: true
  parallel_execution: true
  max_parallel_coders: 3  # Maximum number of coders working simultaneously

  # Code quality settings
  auto_format: true
  auto_lint: true
  commit_message_template: |
    {title}

    {description}

    Task: {task_id}
    Domain: {domain}

    Generated by Agent Pipeline

# Phase 4: QA (Verification + Testing)
phase4:
  enabled: true
  parallel_execution: true  # Run verifier and tester in parallel

  # Verifier settings
  verifier:
    enabled: true
    strict_mode: true  # Strict validation against spec
    check_files_scope: true  # Verify only files in scope were modified

  # Tester settings
  tester:
    enabled: true
    auto_run_tests: true
    test_commands:
      - "npm test"
      - "npm run lint"
    create_issues_on_failure: true  # Create GitHub issues for test failures
    github_labels:
      - "bug"
      - "automated"
      - "pipeline-detected"

# Phase 5: Merger
phase5:
  enabled: true
  require_human_validation: true  # Require human approval before merge

  # Merge settings
  auto_merge: false  # Auto-merge if all checks pass (requires require_human_validation: false)
  cleanup_after_merge: true  # Remove worktree and branch after successful merge

  # Conflict handling - SECURITY: Auto-resolution removed (too risky)
  # Conflicts ALWAYS require manual intervention
  create_conflict_report: true  # Create detailed conflict report for manual resolution

  # Batch merging
  batch_merge_enabled: true  # Merge multiple tasks in one go
  max_batch_size: 5  # Maximum tasks to merge in one batch

# Validation settings
validation:
  # Logic validation (spec compliance)
  logic:
    enabled: true
    check_requirements: true
    check_acceptance_criteria: true
    check_files_scope: true
    min_coverage: 0.8  # Minimum proportion of requirements met

  # Technical validation (tests, lint, build)
  tech:
    enabled: true
    run_tests: true
    run_lint: true
    run_build: false  # Set to true if project has a build step
    allow_warnings: true  # Allow warnings in lint/build
    fail_on_error: true

# Monitoring and reporting
monitoring:
  enabled: true
  stats_interval: 300  # Seconds between stats updates

  # Metrics to track
  metrics:
    - "tasks_created"
    - "tasks_completed"
    - "tasks_failed"
    - "agents_created"
    - "merge_success_rate"
    - "average_task_duration"

  # Notifications (future feature)
  notifications:
    enabled: false
    channels:
      - type: "console"
      - type: "file"
        path: "logs/notifications.log"

# Error handling
error_handling:
  max_retries: 3
  retry_delay: 10  # Seconds between retries
  fail_fast: false  # Stop pipeline on first error

  # Retry loop with feedback injection
  enable_retry_loop: true  # Enable automatic retry with feedback from failed validations
  inject_feedback: true    # Inject validation feedback into retry attempts

  # Error recovery strategies
  on_coder_failure:
    action: "retry"  # retry, skip, abort
    max_attempts: 2

  on_validation_failure:
    action: "retry"  # CHANGED: Now retries with feedback instead of skip
    create_issue: false
    max_attempts: 3

  on_merge_conflict:
    action: "abort_and_report"  # SECURITY: Always abort merge and create report
    create_report: true
    notify_user: true

# Performance settings
performance:
  # Caching
  cache_enabled: true
  cache_dir: ".cache"
  cache_agent_templates: true

  # Optimization
  lazy_loading: true
  connection_pool_size: 10

# Security settings
security:
  # Validation
  validate_file_paths: true  # Prevent path traversal
  allowed_file_extensions:
    - ".js"
    - ".ts"
    - ".jsx"
    - ".tsx"
    - ".py"
    - ".java"
    - ".go"
    - ".rs"
    - ".md"
    - ".json"
    - ".yaml"
    - ".yml"

  # Git safety
  protect_branches:
    - "main"
    - "master"
    - "production"

  require_code_review: false  # Future feature

# Development mode
development:
  enabled: false  # Enable development mode features
  skip_validations: false
  mock_agents: false  # Use mock agents for testing
  verbose_logging: true
